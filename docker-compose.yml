version: "3.8"

services:
  # ============================================================================
  # INFRASTRUCTURE SERVICES
  # ============================================================================

  # Kafka Message Broker
  kafka:
    image: bitnami/kafka:3.5.1
    container_name: kafka
    restart: unless-stopped
    ports:
      - "9092:9092"
    environment:
      KAFKA_KRAFT_CLUSTER_ID: "Z8yQy-uDSsucb45mrW0b4Q"
      KAFKA_CFG_NODE_ID: 1
      KAFKA_CFG_PROCESS_ROLES: controller,broker
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      ALLOW_PLAINTEXT_LISTENER: "yes"
      KAFKA_HEARTBEAT_INTERVAL_MS: 3000
      KAFKA_SESSION_TIMEOUT_MS: 30000
    volumes:
      - kafka-data:/bitnami/kafka
    networks:
      - patient-network
    healthcheck:
      test:
        [
          "CMD",
          "kafka-broker-api-versions",
          "--bootstrap-server",
          "localhost:9092",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Database - Unified database for all relational data
  postgresql:
    image: postgres:15-alpine
    container_name: postgresql
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: patient_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
    volumes:
      - postgresql-data:/var/lib/postgresql/data
    networks:
      - patient-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MongoDB Database
  mongodb:
    image: mongo:6-alpine
    container_name: mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: mongodb123
      MONGO_INITDB_DATABASE: patient_db
    volumes:
      - mongodb-data:/data/db
    networks:
      - patient-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # MICROSERVICES
  # ============================================================================

  # API Gateway - Entry point for all requests
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    restart: unless-stopped
    ports:
      - "4004:4004"
    depends_on:
      kafka:
        condition: service_healthy
      postgresql:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SERVER_PORT: 4004
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      PATIENT_SERVICE_URL: http://patient-management:8080
      AUTH_SERVICE_URL: http://auth-service:8089
      DOCTOR_SERVICE_URL: http://doctor-service:8083
      APPOINTMENT_SERVICE_URL: http://appointment-service:8084
      BILLING_SERVICE_URL: http://billing-service:8081
      ANALYTICS_SERVICE_URL: http://analytics-service:8082
    volumes:
      - ./api-gateway/src:/app/src
    networks:
      - patient-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4004/actuator/health"]
      interval: 15s
      timeout: 5s
      retries: 5

  # Patient Service - Manages patient records (PostgreSQL)
  patient-management:
    build:
      context: ./patient-management
      dockerfile: Dockerfile
    container_name: patient-management
    restart: unless-stopped
    ports:
      - "8080:8080"
    depends_on:
      postgresql:
        condition: service_healthy
      kafka:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SERVER_PORT: 8080
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgresql:5432/patient_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres123
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    volumes:
      - ./patient-management/src:/app/src
    networks:
      - patient-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 15s
      timeout: 5s
      retries: 5

  # Auth Service - Authentication & Authorization (PostgreSQL)
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    restart: unless-stopped
    ports:
      - "8089:8089"
    depends_on:
      postgresql:
        condition: service_healthy
      kafka:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SERVER_PORT: 8089
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgresql:5432/patient_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres123
      JWT_SECRET: your-secret-jwt-key-change-in-production
      API_KEY: your-api-key-change-in-production
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    volumes:
      - ./auth-service/src:/app/src
    networks:
      - patient-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8089/actuator/health"]
      interval: 15s
      timeout: 5s
      retries: 5

  # Doctor Service - Manages doctor profiles (MongoDB)
  doctor-service:
    build:
      context: ./doctor-service
      dockerfile: Dockerfile
    container_name: doctor-service
    restart: unless-stopped
    ports:
      - "8083:8083"
    depends_on:
      mongodb:
        condition: service_healthy
      kafka:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SERVER_PORT: 8083
      SPRING_DATA_MONGODB_URI: mongodb://admin:mongodb123@mongodb:27017/patient_db?authSource=admin
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    volumes:
      - ./doctor-service/src:/app/src
    networks:
      - patient-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/actuator/health"]
      interval: 15s
      timeout: 5s
      retries: 5

  # Appointment Service - Manages appointments (PostgreSQL)
  appointment-service:
    build:
      context: ./appointment-service
      dockerfile: Dockerfile
    container_name: appointment-service
    restart: unless-stopped
    ports:
      - "8084:8084"
    depends_on:
      postgresql:
        condition: service_healthy
      kafka:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SERVER_PORT: 8084
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgresql:5432/patient_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres123
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    volumes:
      - ./appointment-service/src:/app/src
    networks:
      - patient-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/actuator/health"]
      interval: 15s
      timeout: 5s
      retries: 5

  # Billing Service - Manages billing & payments (PostgreSQL)
  billing-service:
    build:
      context: ./billing-service
      dockerfile: Dockerfile
    container_name: billing-service
    restart: unless-stopped
    ports:
      - "8081:8081"
    depends_on:
      postgresql:
        condition: service_healthy
      kafka:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SERVER_PORT: 8081
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgresql:5432/patient_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres123
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    volumes:
      - ./billing-service/src:/app/src
    networks:
      - patient-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 15s
      timeout: 5s
      retries: 5

  # Analytics Service - Analytics & Reporting (MongoDB)
  analytics-service:
    build:
      context: ./analytics-service
      dockerfile: Dockerfile
    container_name: analytics-service
    restart: unless-stopped
    ports:
      - "8082:8082"
    depends_on:
      mongodb:
        condition: service_healthy
      kafka:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SERVER_PORT: 8082
      SPRING_DATA_MONGODB_URI: mongodb://admin:mongodb123@mongodb:27017/patient_db?authSource=admin
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    volumes:
      - ./analytics-service/src:/app/src
    networks:
      - patient-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/actuator/health"]
      interval: 15s
      timeout: 5s
      retries: 5

# Named volumes for persistent data
volumes:
  kafka-data:
    driver: local
  postgresql-data:
    driver: local
  mongodb-data:
    driver: local

# Network configuration
networks:
  patient-network:
    driver: bridge
